// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}


model Merchant {
  id                 String   @id @default(cuid())
  business_name      String
  email              String   @unique
  phone_number       String   @unique
  country            String
  settlement_currency String
  password           String
  status             MerchantStatus @default(pending_verification)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  otps               OTP[]
  payments           Payment[]
}

model OTP {
  id          String   @id @default(cuid())
  merchant    Merchant @relation(fields: [merchantId], references: [id])
  merchantId  String
  channel     OTPChannel
  code        String
  expires_at  DateTime
  created_at  DateTime @default(now())

  @@unique([merchantId, channel])
}

enum MerchantStatus {
  pending_verification
  active
}

enum OTPChannel {
  email
  phone
}

model Payment {
  id                    String   @id @default(uuid())
  merchant              Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  merchantId            String
  payment_id            String   @unique
  order_id              String
  customer              Customer @relation(fields: [customerId], references: [id])
  customerId            String
  amount                Float
  currency              String
  status                PaymentStatus
  description           String?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
  transaction_hash      String?
  transactions          Transaction[]
  timeline_events       TimelineEvent[]

  @@index([merchantId])
  @@index([customerId])
  @@index([status])
  @@index([created_at])
}

model Customer {
  id        String   @id @default(cuid())
  email     String
  name      String
  phone     String?
  created_at DateTime @default(now())
  payments  Payment[]

  @@unique([email])
}

model Transaction {
  id              String   @id @default(cuid())
  payment         Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  paymentId       String
  transaction_hash String
  amount          Float
  currency        String
  source_account  String
  destination_account String
  status          TransactionStatus
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([paymentId])
}

model TimelineEvent {
  id        String   @id @default(cuid())
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  paymentId String
  event_type String
  description String?
  created_at DateTime @default(now())

  @@index([paymentId])
}

enum PaymentStatus {
  pending
  completed
  failed
  cancelled
}

enum TransactionStatus {
  pending
  confirmed
  failed
}